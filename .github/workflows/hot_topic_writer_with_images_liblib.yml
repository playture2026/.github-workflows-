name: Hot Topic Auto Writer with Images (LiblibAI)

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©0ç‚¹UTCæ‰§è¡Œï¼ˆåŒ—äº¬æ—¶é—´æ—©ä¸Š8ç‚¹ï¼‰
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  writer:
    runs-on: ubuntu-latest
    
    steps:
      - name: è·å–ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # è®¾ç½®Pythonç¯å¢ƒ
      - name: è®¾ç½®Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      # å®‰è£…ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: |
          pip install requests beautifulsoup4 lxml openai pillow
      
      # æ­¥éª¤1ï¼šè·å–çƒ­ç‚¹æ•°æ®
      - name: è·å–çƒ­ç‚¹è¯é¢˜
        id: fetch_hot_topics
        run: |
          python << 'EOF'
          import requests
          import json
          from datetime import datetime
          
          # æ¨¡æ‹Ÿçƒ­ç‚¹æ•°æ®ï¼ˆå®é™…ä½¿ç”¨æ—¶éœ€è¦è§£æçœŸå®æ•°æ®ï¼‰
          hot_topics = [
              {
                  "title": "ç¤ºä¾‹çƒ­ç‚¹1ï¼šAIæŠ€æœ¯åœ¨åŒ»ç–—é¢†åŸŸçš„çªç ´æ€§è¿›å±•",
                  "platform": "ä»Šæ—¥å¤´æ¡",
                  "hotness": 1000000,
                  "url": "https://example.com/news1"
              },
              {
                  "title": "ç¤ºä¾‹çƒ­ç‚¹2ï¼šæ–°èƒ½æºæ±½è½¦é”€é‡å†åˆ›æ–°é«˜",
                  "platform": "å¾®åš",
                  "hotness": 850000,
                  "url": "https://example.com/news2"
              },
              {
                  "title": "ç¤ºä¾‹çƒ­ç‚¹3ï¼šé‡å­è®¡ç®—å–å¾—é‡è¦é‡Œç¨‹ç¢‘",
                  "platform": "ä»Šæ—¥å¤´æ¡",
                  "hotness": 720000,
                  "url": "https://example.com/news3"
              }
          ]
          
          # ä¿å­˜çƒ­ç‚¹æ•°æ®
          with open('hot_topics.json', 'w', encoding='utf-8') as f:
              json.dump(hot_topics, f, ensure_ascii=False, indent=2)
          
          print(f"è·å–åˆ° {len(hot_topics)} ä¸ªçƒ­ç‚¹è¯é¢˜")
          
          EOF
      
      # æ­¥éª¤2ï¼šAIç”Ÿæˆæ–‡æ¡ˆ + é…å›¾ï¼ˆä½¿ç”¨LiblibAIï¼‰
      - name: AIç”Ÿæˆæ–‡æ¡ˆå’Œé…å›¾
        id: ai_generation
        run: |
          python << 'EOF'
          import json
          import os
          import base64
          import requests
          from datetime import datetime
          from openai import OpenAI
          
          # è¯»å–çƒ­ç‚¹æ•°æ®
          with open('hot_topics.json', 'r', encoding='utf-8') as f:
              hot_topics = json.load(f)
          
          # åˆå§‹åŒ–æ–‡æœ¬ç”Ÿæˆå®¢æˆ·ç«¯ï¼ˆä½¿ç”¨DeepSeekï¼‰
          text_client = OpenAI(
              api_key="${{ secrets.DEEPSEEK_API_KEY }}",
              base_url="https://api.deepseek.com"
          )
          
          # LiblibAIé…ç½®
          LIBLIB_API_BASE = "${{ secrets.LIBLIB_API_BASE or 'https://api.liblib.art' }}"
          LIBLIB_ACCESS_TOKEN = "${{ secrets.LIBLIB_ACCESS_TOKEN }}"
          LIBLIB_MODEL_ID = "${{ secrets.LIBLIB_MODEL_ID or 'sd_xl_base_1.0' }}"
          
          # ç³»ç»Ÿæç¤ºè¯
          system_prompt = "ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ä»Šæ—¥å¤´æ¡è‡ªåª’ä½“æ’°ç¨¿äººï¼Œæ“…é•¿æ ¹æ®çƒ­ç‚¹è¯é¢˜åˆ›ä½œå¸å¼•äººçš„æ–‡ç« ã€‚\n\nå†™ä½œè¦æ±‚ï¼š\n1. æ ‡é¢˜è¦å¸å¼•äººä½†ä¸æ ‡é¢˜å…šï¼Œä½“ç°æ ¸å¿ƒè§‚ç‚¹\n2. æ­£æ–‡1200-1500å­—ï¼Œåˆ†æ®µæ¸…æ™°ï¼Œé€‚åˆæ‰‹æœºé˜…è¯»\n3. å¿…é¡»æœ‰ä¸ªäººè§‚ç‚¹ï¼Œä¸èƒ½åªæ˜¯å®¢è§‚é™ˆè¿°\n4. æ¯æ®µä¸è¶…è¿‡200å­—ï¼Œä½¿ç”¨çŸ­å¥\n5. å…³é”®æ•°æ®è¦ç”¨å…·ä½“æ•°å­—ï¼ˆå³ä½¿éœ€è¦åˆç†ä¼°ç®—ï¼‰\n6. ç»“å°¾è¦æœ‰äº’åŠ¨å¼•å¯¼ï¼ˆæé—®æˆ–è¯„è®ºé‚€è¯·ï¼‰\n7. è¯­è¨€é£æ ¼ï¼šäº²åˆ‡è‡ªç„¶ï¼Œåƒå’Œæœ‹å‹èŠå¤©\n\nè¾“å‡ºæ ¼å¼ï¼ˆJSONï¼‰ï¼š\n{\"title\": \"æ–‡ç« æ ‡é¢˜\", \"content\": \"æ­£æ–‡å†…å®¹ï¼ˆä½¿ç”¨\\\\n\\\\nåˆ†æ®µï¼‰\", \"summary\": \"50å­—æ‘˜è¦\", \"tags\": [\"æ ‡ç­¾1\", \"æ ‡ç­¾2\", \"æ ‡ç­¾3\"], \"image_prompt\": \"ç”¨äºç”Ÿæˆå°é¢å›¾çš„ä¸­æ–‡æç¤ºè¯\"}"
          
          # ä¸ºæ¯ä¸ªçƒ­ç‚¹ç”Ÿæˆæ–‡æ¡ˆå’Œé…å›¾
          articles = []
          images = []
          
          for idx, topic in enumerate(hot_topics[:3], 1):  # åªå¤„ç†å‰3ä¸ª
              print(f"\\næ­£åœ¨ä¸ºç¬¬{idx}ä¸ªçƒ­ç‚¹ç”Ÿæˆæ–‡æ¡ˆï¼š{topic['title']}")
              
              user_prompt = f"""è¯·æ ¹æ®ä»¥ä¸‹çƒ­ç‚¹è¯é¢˜ï¼Œå†™ä¸€ç¯‡é€‚åˆä»Šæ—¥å¤´æ¡çš„æ–‡ç« ï¼š

çƒ­ç‚¹æ ‡é¢˜ï¼š{topic['title']}
æ¥æºå¹³å°ï¼š{topic['platform']}
çƒ­åº¦å€¼ï¼š{topic['hotness']}

è¦æ±‚ï¼š
- æ·±å…¥åˆ†æè¿™ä¸ªçƒ­ç‚¹çš„æ¥é¾™å»è„‰
- æä¾›ç‹¬ç‰¹çš„ä¸ªäººè§‚ç‚¹
- ç»™è¯»è€…å¸¦æ¥å®é™…ä»·å€¼æˆ–æ–°è®¤çŸ¥
- é¿å…å£æ°´è¯ï¼Œæ¯å¥è¯éƒ½è¦æœ‰æ„ä¹‰
- åŒæ—¶ç”Ÿæˆä¸€ä¸ªé€‚åˆä½œä¸ºå°é¢å›¾çš„ä¸­æ–‡æç¤ºè¯ï¼ˆimage_promptï¼‰ï¼Œè¦æ±‚ç®€æ´æœ‰åŠ›ï¼Œé€‚åˆAIç»˜ç”»
"""
              
              try:
                  # ç”Ÿæˆæ–‡æ¡ˆ
                  response = text_client.chat.completions.create(
                      model="deepseek-chat",
                      messages=[
                          {"role": "system", "content": system_prompt},
                          {"role": "user", "content": user_prompt}
                      ],
                      temperature=0.8,
                      max_tokens=2000
                  )
                  
                  # è§£æAIè¿”å›çš„å†…å®¹
                  ai_content = response.choices[0].message.content
                  
                  # å°è¯•è§£æJSONæ ¼å¼
                  try:
                      article_data = json.loads(ai_content)
                  except json.JSONDecodeError:
                      # å¦‚æœAIæ²¡æœ‰è¿”å›JSONæ ¼å¼ï¼Œæ‰‹åŠ¨æ„å»º
                      article_data = {
                          "title": topic['title'],
                          "content": ai_content,
                          "summary": ai_content[:50] + "...",
                          "tags": ["çƒ­ç‚¹", "èµ„è®¯"],
                          "image_prompt": topic['title'] + "ï¼Œä¸“ä¸šæ’å›¾ï¼Œç°ä»£è®¾è®¡"
                      }
                  
                  # ç”Ÿæˆé…å›¾ï¼ˆä½¿ç”¨LiblibAIï¼‰
                  image_prompt = article_data.get('image_prompt', 
                      f"{article_data['title']}ï¼Œä¸“ä¸šæ’å›¾ï¼Œç°ä»£è®¾è®¡ï¼Œå¹²å‡€èƒŒæ™¯")
                  
                  print(f"æ­£åœ¨ç”Ÿæˆé…å›¾ï¼Œæç¤ºè¯ï¼š{image_prompt}")
                  
                  # è°ƒç”¨LiblibAI APIç”Ÿæˆå›¾ç‰‡
                  liblib_headers = {
                      "Authorization": f"Bearer {LIBLIB_ACCESS_TOKEN}",
                      "Content-Type": "application/json"
                  }
                  
                  liblib_payload = {
                      "prompt": image_prompt,
                      "negative_prompt": "ä½è´¨é‡ï¼Œæ¨¡ç³Šï¼Œè§£å‰–ç»“æ„é”™è¯¯ï¼Œå¤šæŒ‡ï¼Œä¸‘é™‹ï¼Œæ°´å°",
                      "model": LIBLIB_MODEL_ID,
                      "width": 1024,
                      "height": 1024,
                      "steps": 30,
                      "cfg_scale": 7
                  }
                  
                  liblib_response = requests.post(
                      f"{LIBLIB_API_BASE}/v1/images/generations",
                      headers=liblib_headers,
                      json=liblib_payload,
                      timeout=60
                  )
                  
                  if liblib_response.status_code != 200:
                      raise Exception(f"LiblibAI APIè°ƒç”¨å¤±è´¥: {liblib_response.text}")
                  
                  liblib_result = liblib_response.json()
                  
                  # å¤„ç†è¿”å›çš„å›¾ç‰‡ï¼ˆæ”¯æŒURLæˆ–Base64ï¼‰
                  if "images" in liblib_result and len(liblib_result["images"]) > 0:
                      if "url" in liblib_result["images"][0]:
                          # æ–¹å¼1ï¼šè¿”å›å›¾ç‰‡URLï¼Œéœ€è¦ä¸‹è½½
                          image_url = liblib_result["images"][0]["url"]
                          image_filename = f"article_{idx}_image.png"
                          
                          import urllib.request
                          urllib.request.urlretrieve(image_url, image_filename)
                          
                      elif "b64_json" in liblib_result["images"][0]:
                          # æ–¹å¼2ï¼šè¿”å›Base64ç¼–ç ï¼Œç›´æ¥è§£ç ä¿å­˜
                          image_data = base64.b64decode(liblib_result["images"][0]["b64_json"])
                          image_filename = f"article_{idx}_image.png"
                          
                          with open(image_filename, 'wb') as img_file:
                              img_file.write(image_data)
                      else:
                          raise Exception("LiblibAIè¿”å›çš„æ•°æ®æ ¼å¼ä¸ç¬¦åˆé¢„æœŸ")
                  else:
                      raise Exception("LiblibAIæœªè¿”å›å›¾ç‰‡æ•°æ®")
                  
                  print(f"âœ“ æ–‡ç« ç”ŸæˆæˆåŠŸï¼š{article_data['title']}")
                  print(f"âœ“ é…å›¾ç”ŸæˆæˆåŠŸï¼š{image_filename}")
                  
                  article_data['source_topic'] = topic
                  article_data['generated_at'] = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                  article_data['image_filename'] = image_filename
                  article_data['image_prompt'] = image_prompt
                  articles.append(article_data)
                  images.append(image_filename)
                  
              except Exception as e:
                  print(f"âœ— ç”Ÿæˆå¤±è´¥ï¼š{str(e)}")
                  # ç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªçƒ­ç‚¹
                  continue
          
          # ä¿å­˜æ‰€æœ‰æ–‡ç« 
          with open('generated_articles.json', 'w', encoding='utf-8') as f:
              json.dump(articles, f, ensure_ascii=False, indent=2)
          
          print(f"\\nå…±ç”Ÿæˆ {len(articles)} ç¯‡æ–‡ç«  + {len(images)} å¼ é…å›¾")
          
          # ç”Ÿæˆé‚®ä»¶æ­£æ–‡ï¼ˆåŒ…å«å›¾ç‰‡é“¾æ¥ï¼‰
          email_body = f"""ä»Šæ—¥çƒ­ç‚¹è‡ªåŠ¨æ–‡æ¡ˆ - {datetime.now().strftime('%Yå¹´%mæœˆ%dæ—¥')}
===================================

å…±ç”Ÿæˆ {len(articles)} ç¯‡æ–‡ç« ï¼ˆæ¯ç¯‡å‡åŒ…å«AIç”Ÿæˆçš„é…å›¾ï¼‰ï¼š
"""
          
          for idx, article in enumerate(articles, 1):
              email_body += f"""
--------------------
ã€æ–‡ç«  {idx}ã€‘
æ ‡é¢˜ï¼š{article['title']}
æ‘˜è¦ï¼š{article['summary']}
æ ‡ç­¾ï¼š{', '.join(article['tags'])}

ã€æ­£æ–‡å†…å®¹ã€‘
{article['content']}

ã€AIç”Ÿæˆé…å›¾ã€‘
æç¤ºè¯ï¼š{article['image_prompt']}
æ–‡ä»¶åï¼š{article['image_filename']}
å›¾ç‰‡å·²ä¸Šä¼ è‡³GitHub Releaseé™„ä»¶

ã€åŸå§‹çƒ­ç‚¹ã€‘
æ¥æºï¼š{article['source_topic']['platform']}
çƒ­åº¦ï¼š{article['source_topic']['hotness']:,}

"""
          
          email_body += f"""
===================================
ç”Ÿæˆæ—¶é—´ï¼š{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
ç”±AIåŠ©æ‰‹è‡ªåŠ¨ç”Ÿæˆ | GitHub Actions + LiblibAI
"""
          
          # ä¿å­˜é‚®ä»¶æ­£æ–‡åˆ°æ–‡ä»¶
          with open('email_body.txt', 'w', encoding='utf-8') as f:
              f.write(email_body)
          
          print("é‚®ä»¶æ­£æ–‡å·²ç”Ÿæˆ")
          
          EOF
      
      # æ­¥éª¤3ï¼šå‘é€é‚®ä»¶é€šçŸ¥
      - name: å‘é€é‚®ä»¶é€šçŸ¥
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "ğŸ“ğŸ–¼ï¸ ä»Šæ—¥çƒ­ç‚¹è‡ªåŠ¨æ–‡æ¡ˆ+é…å›¾ (LiblibAI) - ${{ github.event.head_commit.timestamp || 'åˆšåˆšç”Ÿæˆ' }}"
          to: ${{ secrets.EMAIL_TO }}
          from: "AIçƒ­ç‚¹åŠ©æ‰‹ <${{ secrets.EMAIL_USERNAME }}>"
          priority: high
          body: file://email_body.txt
          convert_markdown: false
          attachments: |
            article_1_image.png,article_2_image.png,article_3_image.png
      
      # æ­¥éª¤4ï¼šä¸Šä¼ æ–‡ç« å’Œå›¾ç‰‡åˆ°ä»“åº“
      - name: ä¸Šä¼ ç”Ÿæˆçš„æ–‡ç« å’Œå›¾ç‰‡
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ¤– AIç”Ÿæˆä»Šæ—¥çƒ­ç‚¹æ–‡æ¡ˆ+é…å›¾ (LiblibAI) ${{ github.event.head_commit.timestamp || 'è‡ªåŠ¨æäº¤' }}"
          file_pattern: 'generated_articles.json hot_topics.json article_*.png'
          skip_dirty_check: true
          skip_fetch: true
          
      # æ­¥éª¤5ï¼šåˆ›å»ºå‘å¸ƒï¼ˆåŒ…å«å›¾ç‰‡ï¼‰
      - name: åˆ›å»ºæ¯æ—¥å‘å¸ƒ
        uses: softprops/action-gh-release@v1
        with:
          tag_name: daily-${{ github.event.head_commit.sha || 'latest' }}
          name: "ğŸ“„ğŸ–¼ï¸ ä»Šæ—¥çƒ­ç‚¹æ–‡æ¡ˆ+é…å›¾ (LiblibAI) - ${{ github.event.head_commit.timestamp || 'æœ€æ–°' }}"
          body: |
            ## ä»Šæ—¥è‡ªåŠ¨ç”Ÿæˆçš„çƒ­ç‚¹æ–‡æ¡ˆï¼ˆå«AIé…å›¾ï¼‰
            
            æœ¬å‘å¸ƒåŒ…å«äº†AIæ ¹æ®ä»Šæ—¥çƒ­ç‚¹è‡ªåŠ¨ç”Ÿæˆçš„3ç¯‡æ–‡ç« ï¼Œæ¯ç¯‡æ–‡ç« éƒ½é…æœ‰LiblibAIç”Ÿæˆçš„å°é¢å›¾ã€‚
            
            ### ğŸ“š æ–‡ç« åˆ—è¡¨
            
            ğŸ“„ æŸ¥çœ‹å®Œæ•´å†…å®¹è¯·ä¸‹è½½ `generated_articles.json` æ–‡ä»¶ã€‚
            
            ### ğŸ–¼ï¸ é…å›¾åˆ—è¡¨
            
            æ¯ç¯‡æ–‡ç« éƒ½æœ‰ä¸€å¼ AIç”Ÿæˆçš„1024x1024å°é¢å›¾ï¼š
            - `article_1_image.png` - ç¬¬ä¸€ç¯‡æ–‡ç« é…å›¾
            - `article_2_image.png` - ç¬¬äºŒç¯‡æ–‡ç« é…å›¾
            - `article_3_image.png` - ç¬¬ä¸‰ç¯‡æ–‡ç« é…å›¾
            
            ---
            
            ğŸ¤– ç”±GitHub Actions + DeepSeek AI + LiblibAIè‡ªåŠ¨ç”Ÿæˆ
          files: |
            generated_articles.json
            hot_topics.json
            email_body.txt
            article_*.png
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # æ­¥éª¤6ï¼šæ¸…ç†æ—§æ•°æ®ï¼ˆä¿ç•™æœ€è¿‘30å¤©ï¼‰
      - name: æ¸…ç†å†å²æ•°æ®
        run: |
          git fetch --prune --unshallow
          git for-each-ref --sort=-committerdate refs/tags/ | tail -n +31 | while read tag; do
            git push origin --delete $(echo $tag | awk '{print $3}')
          done || true
