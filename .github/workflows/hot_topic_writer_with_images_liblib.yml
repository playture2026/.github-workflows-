name: Hot Topic Auto Writer with Images

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤© UTC æ—¶é—´ 00:00 è¿è¡Œ
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

env:
  PYTHON_VERSION: '3.11'

jobs:
  writer:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 lxml openai pillow

      - name: Verify Required Secrets
        run: |
          if [ -z "${{ secrets.DEEPSEEK_API_KEY }}" ]; then
            echo "Error: Missing DEEPSEEK_API_KEY secret"
            exit 1
          fi
          if [ -z "${{ secrets.LIBLIB_ACCESS_TOKEN }}" ]; then
            echo "Error: Missing LIBLIB_ACCESS_TOKEN secret"
            exit 1
          fi
          if [ -z "${{ secrets.EMAIL_USERNAME }}" ] || [ -z "${{ secrets.EMAIL_PASSWORD }}" ]; then
            echo "Error: Missing EMAIL credentials"
            exit 1
          fi
          echo "All required secrets are present"

      - name: Fetch Trending Topics
        id: fetch_trends
        run: |
          python3 -c "
          import json
          import requests
          from datetime import datetime
          
          # è·å–çƒ­é—¨è¯é¢˜æ•°æ®
          def get_hot_topics():
              # æ¨¡æ‹ŸçœŸå®æ•°æ®è·å–ï¼ˆå®é™…é¡¹ç›®ä¸­åº”æ›¿æ¢ä¸ºçœŸå®çš„APIè°ƒç”¨ï¼‰
              hot_topics = [
                  {
                      'title': f'ä»Šæ—¥ç§‘æŠ€çªç ´ï¼š{datetime.now().strftime(\"%mæœˆ%dæ—¥\")}AIæ–°è¿›å±•',
                      'platform': 'TechNews',
                      'hotness': 1200000,
                      'url': 'https://example.com/news1',
                      'category': 'ç§‘æŠ€'
                  },
                  {
                      'title': f'æ–°èƒ½æºæ±½è½¦é”€é‡å†åˆ›æ–°é«˜ - {datetime.now().strftime(\"%Yå¹´\")}',
                      'platform': 'FinanceDaily',
                      'hotness': 950000,
                      'url': 'https://example.com/news2',
                      'category': 'è´¢ç»'
                  },
                  {
                      'title': f'é‡å­è®¡ç®—å–å¾—é‡è¦é‡Œç¨‹ç¢‘çªç ´',
                      'platform': 'ScienceWeekly',
                      'hotness': 820000,
                      'url': 'https://example.com/news3',
                      'category': 'ç§‘å­¦'
                  }
              ]
              return hot_topics
          
          # è·å–å¹¶ä¿å­˜çƒ­é—¨è¯é¢˜
          hot_topics = get_hot_topics()
          
          # ä¿å­˜æ•°æ®åˆ°æ–‡ä»¶
          with open('hot_topics.json', 'w', encoding='utf-8') as f:
              json.dump(hot_topics, f, ensure_ascii=False, indent=2)
          
          # è®¾ç½®è¾“å‡ºå€¼
          print(f'::set-output name=topic_count::{len(hot_topics)}')
          print(f'::set-output name=first_title::{hot_topics[0]["title"]}')
          "

      - name: Generate Content and Images with AI
        id: ai_generation
        run: |
          # åˆ›å»ºç³»ç»Ÿæç¤ºæ–‡ä»¶
          cat > system_prompt.txt << 'EOPROMPT'
          You are a professional media writer skilled at creating attractive articles based on trending topics.
          
          Writing requirements:
          1. Title should be attractive but not clickbait
          2. Main content 1200-1500 words, well-structured
          3. Include personal opinions and analysis
          4. Use specific numbers and data points
          5. End with interactive questions
          
          Output format (JSON):
          {
            "title": "Article title",
            "content": "Main content (use \n\n for paragraph breaks)",
            "summary": "50-word summary",
            "tags": ["Tag1", "Tag2", "Tag3"],
            "image_prompt": "Detailed prompt for generating cover image"
          }
          EOPROMPT
          
          python3 -c "
          import json
          import os
          import base64
          import requests
          from datetime import datetime
          from openai import OpenAI
          
          # è¯»å–çƒ­é—¨è¯é¢˜æ•°æ®
          with open('hot_topics.json', 'r', encoding='utf-8') as f:
              hot_topics = json.load(f)
          
          # è¯»å–ç³»ç»Ÿæç¤º
          with open('system_prompt.txt', 'r', encoding='utf-8') as f:
              system_prompt = f.read()
          
          # åˆå§‹åŒ–DeepSeekå®¢æˆ·ç«¯
          client = OpenAI(
              api_key='${{ secrets.DEEPSEEK_API_KEY }}',
              base_url='https://api.deepseek.com'
          )
          
          # LiblibAIé…ç½®
          LIBLIB_API_BASE = '${{ secrets.LIBLIB_API_BASE || ''https://api.liblib.art'' }}'
          LIBLIB_ACCESS_TOKEN = '${{ secrets.LIBLIB_ACCESS_TOKEN }}'
          LIBLIB_MODEL_ID = '${{ secrets.LIBLIB_MODEL_ID || ''sd_xl_base_1.0'' }}'
          
          # å­˜å‚¨ç”Ÿæˆçš„æ–‡ç« 
          articles = []
          
          for idx, topic in enumerate(hot_topics[:3], 1):
              print(f'\\nProcessing topic {idx}: {topic[\"title\"]}')
              
              user_prompt = f'''
              Please write a Toutiao-style article based on this trending topic:
              
              Topic: {topic['title']}
              Platform: {topic['platform']}
              Popularity: {topic['hotness']}
              Category: {topic.get('category', 'General')}
              
              Requirements:
              - In-depth analysis with unique insights
              - Practical value for readers
              - Concise and engaging writing
              - Include Chinese prompt for cover image
              '''
              
              try:
                  # è°ƒç”¨AIç”Ÿæˆæ–‡ç« 
                  response = client.chat.completions.create(
                      model='deepseek-chat',
                      messages=[
                          {'role': 'system', 'content': system_prompt},
                          {'role': 'user', 'content': user_prompt}
                      ],
                      temperature=0.8,
                      max_tokens=2000
                  )
                  
                  # è§£æè¿”å›çš„å†…å®¹
                  ai_content = response.choices[0].message.content.strip()
                  
                  # å°è¯•æå–JSONéƒ¨åˆ†
                  article_data = {}
                  start_idx = ai_content.find('{')
                  end_idx = ai_content.rfind('}') + 1
                  if start_idx != -1 and end_idx != 0:
                      json_str = ai_content[start_idx:end_idx]
                      try:
                          article_data = json.loads(json_str)
                      except json.JSONDecodeError:
                          print('JSON parsing failed, using fallback')
                          article_data = {
                              'title': topic['title'],
                              'content': ai_content.replace('\\n', '\\n\\n'),
                              'summary': ai_content[:50] + '...',
                              'tags': [topic.get('category', 'Trends'), 'News'],
                              'image_prompt': topic['title'] + ', professional illustration'
                          }
                  
                  # ç”Ÿæˆå›¾åƒ
                  image_prompt = article_data.get('image_prompt', 
                      f'{article_data[\"title\"]}, professional illustration, modern design')
                  
                  print(f'Generating image with prompt: {image_prompt}')
                  
                  # è°ƒç”¨LiblibAIç”Ÿæˆå›¾åƒ
                  headers = {
                      'Authorization': f'Bearer {LIBLIB_ACCESS_TOKEN}',
                      'Content-Type': 'application/json'
                  }
                  
                  payload = {
                      'prompt': image_prompt,
                      'negative_prompt': 'low quality, blurry, bad anatomy',
                      'model': LIBLIB_MODEL_ID,
                      'width': 1024,
                      'height': 1024,
                      'steps': 30,
                      'cfg_scale': 7
                  }
                  
                  image_response = requests.post(
                      f'{LIBLIB_API_BASE}/v1/images/generations',
                      headers=headers,
                      json=payload,
                      timeout=120
                  )
                  
                  if image_response.status_code == 200:
                      result = image_response.json()
                      if 'images' in result and len(result['images']) > 0:
                          if 'url' in result['images'][0]:
                              # ä¸‹è½½å›¾åƒ
                              image_url = result['images'][0]['url']
                              image_filename = f'article_{idx}_image.png'
                              import urllib.request
                              urllib.request.urlretrieve(image_url, image_filename)
                          elif 'b64_json' in result['images'][0]:
                              # è§£ç Base64å›¾åƒ
                              image_data = base64.b64decode(result['images'][0]['b64_json'])
                              image_filename = f'article_{idx}_image.png'
                              with open(image_filename, 'wb') as img_file:
                                  img_file.write(image_data)
                          else:
                              # åˆ›å»ºå ä½ç¬¦å›¾åƒ
                              from PIL import Image
                              img = Image.new('RGB', (1024, 1024), color='lightblue')
                              image_filename = f'article_{idx}_image.png'
                              img.save(image_filename)
                      else:
                          # åˆ›å»ºå ä½ç¬¦å›¾åƒ
                          from PIL import Image
                          img = Image.new('RGB', (1024, 1024), color='lightgreen')
                          image_filename = f'article_{idx}_image.png'
                          img.save(image_filename)
                  else:
                      # åˆ›å»ºå ä½ç¬¦å›¾åƒ
                      from PIL import Image
                      img = Image.new('RGB', (1024, 1024), color='lightgray')
                      image_filename = f'article_{idx}_image.png'
                      img.save(image_filename)
                  
                  # æ·»åŠ é¢å¤–ä¿¡æ¯
                  article_data['source_topic'] = topic
                  article_data['generated_at'] = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                  article_data['image_filename'] = image_filename
                  
                  articles.append(article_data)
                  print(f'Successfully generated article: {article_data[\"title\"]}')
                  
              except Exception as e:
                  print(f'Error generating article {idx}: {str(e)}')
                  continue
          
          # ä¿å­˜æ‰€æœ‰æ–‡ç« 
          with open('generated_articles.json', 'w', encoding='utf-8') as f:
              json.dump(articles, f, ensure_ascii=False, indent=2)
          
          print(f'\\nSuccessfully generated {len(articles)} articles with images')
          "
        
        if: steps.fetch_trends.outputs.topic_count > 0

      - name: Prepare Email Content
        run: |
          python3 -c "
          import json
          from datetime import datetime
          
          # è¯»å–ç”Ÿæˆçš„æ–‡ç« 
          try:
              with open('generated_articles.json', 'r', encoding='utf-8') as f:
                  articles = json.load(f)
          except FileNotFoundError:
              articles = []
          
          # ç”Ÿæˆé‚®ä»¶å†…å®¹
          email_body = f'''Today's Trending Auto Copy - {datetime.now().strftime('%Y-%m-%d')}
          ===================================
          
          Generated {len(articles)} articles (each includes AI-generated image):
          '''
          
          for idx, article in enumerate(articles, 1):
              email_body += f'''
          --------------------
          [Article {idx}]
          Title: {article['title']}
          Summary: {article['summary']}
          Tags: {', '.join(article['tags'])}
          
          [Main Content]
          {article['content'][:500]}...
          
          [AI Generated Image]
          Prompt: {article['image_prompt']}
          Filename: {article['image_filename']}
          
          [Original Trend]
          Source: {article['source_topic']['platform']}
          Popularity: {article['source_topic']['hotness']:,}
          Category: {article['source_topic'].get('category', 'Unknown')}
          
          '''
          
          email_body += f'''
          ===================================
          Generation Time: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
          Automatically generated by AI assistant | GitHub Actions
          '''
          
          # ä¿å­˜é‚®ä»¶å†…å®¹
          with open('email_body.txt', 'w', encoding='utf-8') as f:
              f.write(email_body)
          "
        if: steps.ai_generation.conclusion == 'success'

      - name: Send Email Notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "ğŸ“ğŸ–¼ï¸ Today's Trending Auto Copy+Images - ${{ github.event.head_commit.timestamp || 'Just Generated' }}"
          to: ${{ secrets.EMAIL_TO }}
          from: "AI Trend Assistant <${{ secrets.EMAIL_USERNAME }}>"
          priority: normal
          body: file://email_body.txt
          convert_markdown: false
          attachments: |
            article_1_image.png
            article_2_image.png
            article_3_image.png
        if: ${{ success() && steps.ai_generation.conclusion == 'success' }}

      - name: Commit Generated Files
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add -A
          git commit -m "ğŸ¤– AI generated today's trending content [skip ci]" || echo "No changes to commit"
          git push origin main || echo "Push failed - may be due to no changes"
        if: ${{ success() }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: daily-${{ github.run_id }}
          name: "ğŸ“„ğŸ–¼ï¸ Daily Trending Content - ${{ github.event.head_commit.timestamp || 'Latest' }}"
          body: |
            ## Today's AI-Generated Trending Content
            
            This release contains articles automatically generated based on trending topics, each with an AI-generated cover image.
            
            ### ğŸ“Š Statistics
            - Generated on: ${{ github.event.head_commit.timestamp || 'Now' }}
            - Trending topics processed: ${{ steps.fetch_trends.outputs.topic_count }}
            - Articles created: ${{ steps.ai_generation.conclusion == 'success' && 'Success' || 'Failed' }}
            
            ---
            ğŸ¤– Automatically generated by GitHub Actions + AI
          files: |
            generated_articles.json
            hot_topics.json
            email_body.txt
            article_1_image.png
            article_2_image.png
            article_3_image.png
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        if: ${{ success() }}
