name: Test Secrets

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */3 * * *'  # æ¯3å°æ—¶æ‰§è¡Œä¸€æ¬¡

jobs:
  test-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: è·å–ä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½®Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: æµ‹è¯•æ‰€æœ‰Secrets
        run: |
          python << 'EOF'
          import os
          from datetime import datetime
          
          print("=" * 80)
          print("ğŸ” GitHub Actions Secretsé…ç½®éªŒè¯")
          print("=" * 80)
          print()
          
          secrets = {
              "DEEPSEEK_API_KEY": {
                  "value": os.environ.get('DEEPSEEK_API_KEY', ''),
                  "å¿…éœ€": True,
                  "è¯´æ˜": "AIç”Ÿæˆæ–‡ç« çš„æ ¸å¿ƒAPIå¯†é’¥"
              },
              "PAT_TOKEN": {
                  "value": os.environ.get('PAT_TOKEN', ''),
                  "å¿…éœ€": True,
                  "è¯´æ˜": "ç”¨äºGitæ¨é€ä»£ç åˆ°ä»“åº“"
              },
              "EMAIL_USERNAME": {
                  "value": os.environ.get('EMAIL_USERNAME', ''),
                  "å¿…éœ€": True,
                  "è¯´æ˜": "å‘é€é‚®ä»¶çš„é‚®ç®±åœ°å€"
              },
              "EMAIL_PASSWORD": {
                  "value": os.environ.get('EMAIL_PASSWORD', ''),
                  "å¿…éœ€": True,
                  "è¯´æ˜": "é‚®ç®±æˆæƒç "
              },
              "EMAIL_TO": {
                  "value": os.environ.get('EMAIL_TO', ''),
                  "å¿…éœ€": True,
                  "è¯´æ˜": "æ¥æ”¶é‚®ä»¶çš„é‚®ç®±åœ°å€"
              },
              "LIBLIB_ACCESS_TOKEN": {
                  "value": os.environ.get('LIBLIB_ACCESS_TOKEN', ''),
                  "å¿…éœ€": False,
                  "è¯´æ˜": "AIç”Ÿæˆé…å›¾çš„è®¿é—®ä»¤ç‰Œï¼ˆå¯é€‰ï¼‰"
              }
          }
          
          valid_count = 0
          total_required = sum(1 for s in secrets.values() if s["å¿…éœ€"])
          
          print("ğŸ“‹ Secretsé…ç½®çŠ¶æ€ï¼š")
          print("-" * 80)
          
          for secret_name, config in secrets.items():
              value = config["value"]
              is_required = config["å¿…éœ€"]
              description = config["è¯´æ˜"]
              
              if value:
                  if is_required:
                      status = "âœ… å·²é…ç½®"
                      valid_count += 1
                  else:
                      status = "âœ… å·²é…ç½®ï¼ˆå¯é€‰ï¼‰"
                  display_value = f"âœ“ (é•¿åº¦: {len(value)} å­—ç¬¦)"
              else:
                  if is_required:
                      status = "âŒ æœªé…ç½®"
                  else:
                      status = "âš ï¸  æœªé…ç½®ï¼ˆå¯é€‰ï¼‰"
                  display_value = "âœ— (æœªé…ç½®)"
              
              print(f"\n{status}")
              print(f"Secretåç§°: {secret_name}")
              print(f"è¯´æ˜: {description}")
              print(f"å€¼: {display_value}")
          
          print()
          print("=" * 80)
          print("ğŸ“Š éªŒè¯ç»“æœ:")
          print("=" * 80)
          
          print(f"å¿…éœ€Secrets: {valid_count}/{total_required} å·²é…ç½®")
          
          if valid_count == total_required:
              print("âœ… æ‰€æœ‰å¿…éœ€Secretså·²æ­£ç¡®é…ç½®ï¼")
              print()
              print("ğŸ“‹ å»ºè®®çš„ä¸‹ä¸€æ­¥:")
              print("1. è¿è¡Œä¸»å·¥ä½œæµ 'Hot Topic Auto Writer with Images (LiblibAI)'")
              print("2. æŸ¥çœ‹è¿è¡Œæ—¥å¿—ï¼Œç¡®è®¤æ–‡ç« ç”ŸæˆæˆåŠŸ")
              print("3. æ£€æŸ¥é‚®ä»¶å†…å®¹")
          else:
              missing_count = total_required - valid_count
              print(f"âŒ è¿˜æœ‰ {missing_count} ä¸ªå¿…éœ€Secretsæœªé…ç½®")
              print()
              print("ğŸ“‹ è¯·é…ç½®ä»¥ä¸‹ç¼ºå¤±çš„Secrets:")
              for secret_name, config in secrets.items():
                  if config["å¿…éœ€"] and not config["value"]:
                      print(f"  - {secret_name}: {config['è¯´æ˜']}")
          
          print()
          print("=" * 80)
          print(f"éªŒè¯å®Œæˆæ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
          print("=" * 80)
          EOF
      
      - name: æµ‹è¯•DeepSeek APIè¿æ¥
        if: ${{ secrets.DEEPSEEK_API_KEY != '' }}
        run: |
          python << 'EOF'
          import os
          from openai import OpenAI
          
          print("=" * 80)
          print("ğŸ” æµ‹è¯•DeepSeek APIè¿æ¥")
          print("=" * 80)
          print()
          
          api_key = os.environ.get('DEEPSEEK_API_KEY', '')
          
          if not api_key:
              print("âŒ DEEPSEEK_API_KEYæœªé…ç½®")
              exit(1)
          
          print(f"âœ“ DEEPSEEK_API_KEYå·²é…ç½® (é•¿åº¦: {len(api_key)} å­—ç¬¦)")
          print()
          print("æ­£åœ¨æµ‹è¯•APIè¿æ¥...")
          
          try:
              client = OpenAI(
                  api_key=api_key,
                  base_url="https://api.deepseek.com"
              )
              
              # å‘é€ä¸€ä¸ªç®€å•çš„æµ‹è¯•è¯·æ±‚
              response = client.chat.completions.create(
                  model="deepseek-chat",
                  messages=[
                      {"role": "user", "content": "è¯·å›å¤'æµ‹è¯•æˆåŠŸ'"}
                  ],
                  max_tokens=10
              )
              
              result = response.choices[0].message.content
              print(f"âœ… APIè¿æ¥æˆåŠŸï¼")
              print(f"   å“åº”: {result}")
              print()
              print("ğŸ“‹ DeepSeek APIé…ç½®æ­£ç¡®ï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨")
              
          except Exception as e:
              print(f"âŒ APIè¿æ¥å¤±è´¥: {str(e)}")
              print()
              print("ğŸ“‹ å¯èƒ½çš„åŸå› :")
              print("  1. APIå¯†é’¥æ— æ•ˆæˆ–å·²è¿‡æœŸ")
              print("  2. APIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨")
              print("  3. ç½‘ç»œè¿æ¥é—®é¢˜")
              exit(1)
          
          print("=" * 80)
          EOF
      
      - name: æµ‹è¯•é‚®ä»¶å‘é€
        if: ${{ secrets.EMAIL_USERNAME != '' && secrets.EMAIL_PASSWORD != '' && secrets.EMAIL_TO != '' }}
        continue-on-error: true
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "ğŸ§ª Secretsé…ç½®æµ‹è¯•é‚®ä»¶"
          to: ${{ secrets.EMAIL_TO }}
          from: "AIæµ‹è¯•åŠ©æ‰‹ <${{ secrets.EMAIL_USERNAME }}>"
          priority: normal
          body: |
            è¿™æ˜¯Secretsé…ç½®æµ‹è¯•é‚®ä»¶
            
            å¦‚æœä½ æ”¶åˆ°è¿™å°é‚®ä»¶ï¼Œè¯´æ˜ä»¥ä¸‹Secretsé…ç½®æ­£ç¡®ï¼š
            âœ“ EMAIL_USERNAME
            âœ“ EMAIL_PASSWORD
            âœ“ EMAIL_TO
            
            æ—¶é—´: ${{ github.event.head_commit.timestamp || 'åˆšåˆš' }}
          convert_markdown: false
      
      - name: æµ‹è¯•Gitæ¨é€
        if: ${{ secrets.PAT_TOKEN != '' }}
        run: |
          echo "æµ‹è¯•Gitæ¨é€æƒé™..."
          
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # ä½¿ç”¨PAT_TOKENè¿›è¡Œè®¤è¯
          git remote set-url origin https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/${{ github.repository }}.git
          
          # æµ‹è¯•è·å–è¿œç¨‹åˆ†æ”¯
          git fetch origin main
          
          if [ $? -eq 0 ]; then
              echo "âœ… Gitæ¨é€æƒé™æµ‹è¯•æˆåŠŸï¼"
              echo "   PAT_TOKENé…ç½®æ­£ç¡®ï¼Œå¯ä»¥æ­£å¸¸æ¨é€ä»£ç "
          else
              echo "âŒ Gitæ¨é€æƒé™æµ‹è¯•å¤±è´¥"
              echo "   PAT_TOKENå¯èƒ½æ— æ•ˆæˆ–æƒé™ä¸è¶³"
              exit 1
          fi
